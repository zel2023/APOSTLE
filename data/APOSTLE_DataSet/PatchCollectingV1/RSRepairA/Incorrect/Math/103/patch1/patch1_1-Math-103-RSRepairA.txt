Updated gamma function to handle NaNs