Fix a bug in the similarity function